<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <title>Συλλογή Αστεριών — A-Frame Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; background: #111; color: #fff; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    a-scene { width: 100%; height: 100vh; display: block; }
    #hud {
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 999;
      background: rgba(0,0,0,0.5);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
    }
    #hud b { font-size:16px; }
    #instructions {
      position: absolute;
      left: 12px;
      bottom: 12px;
      z-index: 999;
      background: rgba(0,0,0,0.45);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div id="hud">
    <div><b>Αστέρια απομένουν:</b> <span id="remaining">15</span> / 15</div>
  </div>
  <div id="instructions">
    Κίνηση: W A S D · Συλλογή αστέρα: move cursor πάνω του + δεξί κλικ
  </div>

  <a-scene background="color: #e6d9c9" embedded>
    <a-assets>
      <img id="skyTex" src="assets/sky.jpg" crossorigin="anonymous" onerror="this.remove()" />
      <audio id="tickSound" src="assets/tick.mp3"></audio>
    </a-assets>

    <a-sky src="#skyTex" rotation="0 -30 0" material="color: #f1e7dc"></a-sky>
    <a-entity light="type: ambient; intensity: 0.7"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="-1 3 1"></a-entity>
    <a-plane rotation="-90 0 0" width="8" height="6" color="#dfe7dd"></a-plane>

    <a-box position="-4 1 0" depth="6" height="2.5" width="0.2" color="#d2c4b0"></a-box>
    <a-box position="4 1 0" depth="6" height="2.5" width="0.2" color="#d2c4b0"></a-box>
    <a-box position="0 1 -3" depth="0.2" height="2.5" width="8" color="#d2c4b0"></a-box>
    <a-box position="0 1 3" depth="0.2" height="2.5" width="8" color="#d2c4b0"></a-box>

    <a-plane position="3.89 1 0.5" rotation="0 90 0" width="1.2" height="0.9" color="#9fcdf7" material="opacity:0.85"></a-plane>

    <a-box id="bed" class="obstacle" position="-3.1 0.35 -1" width="2.2" height="0.6" depth="1.8" color="#c0d7c7"></a-box>
    <a-box position="-3.1 0.65 -1.9" width="2.4" height="0.1" depth="0.05" color="#8b6f47"></a-box>

    <a-plane position="-3.1 1.45 -1" rotation="0 0 0" width="0.9" height="0.6" color="#f0e7d8"></a-plane>
    <a-plane position="-3.1 1.45 -0.99" rotation="0 0 0" width="0.7" height="0.4" color="#222" material="opacity:0.6"></a-plane>

    <a-cylinder id="bin" class="obstacle" position="1.6 0.2 2.7" radius="0.18" height="0.4" color="#9e9e9e"></a-cylinder>
    <a-box id="desk" class="obstacle" position="2.3 0.6 -1.9" width="1.6" height="0.8" depth="0.6" color="#b08a60"></a-box>
    <a-box id="chair" class="obstacle" position="2.3 0.35 -1.1" width="0.5" height="0.7" depth="0.5" color="#3b3b3b"></a-box>

    <a-plane id="door" position=" -0.0 1 -3.09" rotation="0 0 0" width="1.2" height="2" color="#6b3f2f" material="side: double"></a-plane>
    <a-plane id="voidBehind" position=" -0.01 1 -3.11" rotation="0 0 0" width="1.2" height="2" color="#000000" visible="false"></a-plane>

    <a-entity id="cameraRig" position="0 1.6 2.5">
      <a-entity camera wasd-controls="acceleration: 30" look-controls>
        <a-entity id="cursor" cursor="rayOrigin: mouse; fuse: false"
                  raycaster="objects: .star, .ui; far: 20"
                  geometry="primitive: ring; radiusInner: 0.007; radiusOuter: 0.012"
                  material="shader: flat; color: #fff; opacity:0.9"
                  position="0 0 -0.5"></a-entity>
      </a-entity>
    </a-entity>

    <a-entity id="soundPlayer" sound="src: #tickSound; autoplay: false"></a-entity>
    <a-entity id="starsRoot"></a-entity>
    <a-entity id="obstaclesDebug"></a-entity>
  </a-scene>

  <script>
    const TOTAL_STARS = 15;
    const STAR_APPEAR_DELAY_MS = 5000;
    const STAR_INTERVAL_MS = 300;
    const SPAWN_BOUNDS = {xMin: -2.5, xMax: 2.5, zMin: -2.6, zMax: 2.6, y: 0.6};
    const OBSTACLES = [
      {id:'bed', cx:-3.1, cy:0.35, cz:-1, hx:1.1, hy:0.3, hz:0.9},
      {id:'bin', cx:1.6, cy:0.2, cz:2.7, hx:0.2, hy:0.2, hz:0.2},
      {id:'desk', cx:2.3, cy:0.6, cz:-1.9, hx:0.8, hy:0.4, hz:0.3},
      {id:'chair', cx:2.3, cy:0.35, cz:-1.1, hx:0.25, hy:0.35, hz:0.25},
      {id:'door', cx:0.0, cy:1.0, cz:-3.09, hx:0.6, hy:1.0, hz:0.05}
    ];
    function aabbIntersects(ax, ay, az, ar, box) {
      return (Math.abs(ax - box.cx) <= (ar + box.hx)) &&
             (Math.abs(ay - box.cy) <= (ar + box.hy)) &&
             (Math.abs(az - box.cz) <= (ar + box.hz));
    }
    document.addEventListener('DOMContentLoaded', () => {
      const scene = document.querySelector('a-scene');
      const starsRoot = document.getElementById('starsRoot');
      const soundPlayer = document.getElementById('soundPlayer');
      const remainingEl = document.getElementById('remaining');
      const cameraRig = document.getElementById('cameraRig');
      const door = document.getElementById('door');
      const voidBehind = document.getElementById('voidBehind');
      let remaining = TOTAL_STARS;
      remainingEl.textContent = remaining;
      window.addEventListener('contextmenu', function(e){ e.preventDefault(); });
      let prevPos = new THREE.Vector3();
      cameraRig.object3D.getWorldPosition(prevPos);
      const PLAYER_RADIUS = 0.25;
      scene.addEventListener('loaded', () => {
        scene.addEventListener('tick', () => {
          const pos = cameraRig.object3D.position;
          let collided = false;
          for (let b of OBSTACLES) {
            if (aabbIntersects(pos.x, pos.y - 1.0, pos.z, PLAYER_RADIUS, b)) {
              collided = true;
              break;
            }
          }
          if (collided) {
            cameraRig.object3D.position.set(prevPos.x, prevPos.y, prevPos.z);
          } else {
            prevPos.set(pos.x, pos.y, pos.z);
          }
        });
      });
      function randomInRange(min, max) { return Math.random() * (max - min) + min; }
      function positionValidForStar(x,z) {
        const SAFE_DIST = 0.45;
        for (let b of OBSTACLES) {
          const dx = x - b.cx;
          const dz = z - b.cz;
          if (Math.abs(dx) <= (b.hx + SAFE_DIST) && Math.abs(dz) <= (b.hz + SAFE_DIST)) return false;
        }
        if (Math.hypot(x - cameraRig.object3D.position.x, z - cameraRig.object3D.position.z) < 0.8) return false;
        return true;
      }
      function spawnOneStar(index) {
        const sp = document.createElement('a-sphere');
        sp.setAttribute('radius', 0.12);
        sp.setAttribute('segments-width', 6);
        sp.setAttribute('segments-height', 6);
        sp.setAttribute('class', 'star star-'+index);
        sp.setAttribute('material', 'color: #ffec3d; shader: standard; emissive: #ffec3d; emissiveIntensity: 1');
        placeStarElement(sp, index);
      }
      function placeStarElement(el, index) {
        let attempt = 0; let x,z;
        do {
          x = randomInRange(SPAWN_BOUNDS.xMin, SPAWN_BOUNDS.xMax);
          z = randomInRange(SPAWN_BOUNDS.zMin, SPAWN_BOUNDS.zMax);
          attempt++;
          if (attempt > 200) break;
        } while (!positionValidForStar(x,z));
        const y = SPAWN_BOUNDS.y + Math.random() * 0.25;
        el.setAttribute('position', `${x} ${y} ${z}`);
        el.setAttribute('animation__float', `property: position; dir: alternate; dur: ${1200 + Math.round(Math.random()*1000)}; loop: true; to: ${x} ${y + 0.15} ${z}`);
        el.setAttribute('scale', '0.01 0.01 0.01');
        starsRoot.appendChild(el);
        setTimeout(()=> { el.setAttribute('animation__appear', `property: scale; to: 1 1 1; dur: 600; easing: easeOutElastic`); }, 50);
        el.addEventListener('mousedown', (evt) => {
          if (evt.button === 2) { collectStar(el); }
        });
      }
      function collectStar(el) {
        if (!el || el.dataset.collected) return;
        el.dataset.collected = '1';
        try { soundPlayer.components.sound.playSound(); } catch(e){}
        el.setAttribute('animation__col', `property: scale; to: 0.01 0.01 0.01; dur: 250; easing: easeInCubic`);
        setTimeout(()=> { if (el.parentNode) el.parentNode.removeChild(el); }, 300);
        remaining = Math.max(0, remaining - 1);
        remainingEl.textContent = remaining;
        if (remaining === 0) onAllStarsCollected();
      }
      function onAllStarsCollected() {
        door.setAttribute('animation__open', 'property: rotation; to: 0 -90 0; dur: 900; easing: easeInOutQuad');
        voidBehind.setAttribute('visible', 'true');
        for (let i=0;i<OBSTACLES.length;i++){
          if (OBSTACLES[i].id === 'door') { OBSTACLES.splice(i,1); break; }
        }
      }
      setTimeout(()=> {
        let spawned = 0;
        const interval = setInterval(()=> {
          if (spawned >= TOTAL_STARS) { clearInterval(interval); return; }
          spawnOneStar(spawned);
          spawned++;
        }, STAR_INTERVAL_MS);
      }, STAR_APPEAR_DELAY_MS);
      const debugRoot = document.getElementById('obstaclesDebug');
      for (const b of OBSTACLES) {
        const vis = document.createElement('a-box');
        vis.setAttribute('position', `${b.cx} ${b.cy} ${b.cz}`);
        vis.setAttribute('width', b.hx*2);
        vis.setAttribute('height', b.hy*2);
        vis.setAttribute('depth', b.hz*2);
        vis.setAttribute('material', 'color: #ff4444; opacity: 0.12');
        debugRoot.appendChild(vis);
      }
      window.addEventListener('keydown', (ev) => {
        if (ev.key === 'r' || ev.key === 'R') {
          while (starsRoot.firstChild) starsRoot.removeChild(starsRoot.firstChild);
          remaining = TOTAL_STARS;
          remainingEl.textContent = remaining;
          door.setAttribute('rotation', '0 0 0');
          voidBehind.setAttribute('visible', 'false');
          const doorInList = OBSTACLES.find(o=>o.id==='door');
          if (!doorInList) OBSTACLES.push({id:'door', cx:0.0, cy:1.0, cz:-3.09, hx:0.6, hy:1.0, hz:0.05});
          let spawned = 0;
          const interval = setInterval(()=> {
            if (spawned >= TOTAL_STARS) { clearInterval(interval); return; }
            spawnOneStar(spawned);
            spawned++;
          }, 150);
        }
      });
    });
  </script>
</body>
</html>

         


